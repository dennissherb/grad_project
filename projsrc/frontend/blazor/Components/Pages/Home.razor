@page "/"

@rendermode InteractiveServer

@using System.Text.Json
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using blazor
@using DataObjects

@inject NavigationManager Navman
@inject HttpClient HttpClient
@inject ProtectedSessionStorage MySession
@inject IJSRuntime JSRuntime
@inject Stack<string> redirStack;

@if (loggedUser != null)
    {
        <div id="ProtectedContent"> 
            <PageTitle>Home</PageTitle>
            <h1>Hello, @loggedUser.UserName</h1>
            Welcome to your new app.
            <button @onclick="SignOut">Sign Out</button>
        </div>
    }


@code 
{
    Account? loggedUser; 
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        loggedUser = (await MySession.GetAsync<Account>("user")).Value;
        if (firstRender) 
        {
            StateHasChanged();
        }
        if (loggedUser == null)
        {
            redirStack.Push(Navman.Uri);
            Navman.NavigateTo("/login");
		} 
    }

    protected async Task SignOut() {
        await MySession.DeleteAsync("user");
        Navman.NavigateTo("/login");
    }
}